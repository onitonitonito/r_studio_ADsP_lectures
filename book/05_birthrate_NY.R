rm(list=ls())
getwd()

#------------------------------------------------------------------
# decompose seasonal data
# "???忡?? 1946?? 1?????? 1959?? 12?????? ???? ?????? ?? ??????
#-------------------------------------------------------------------


births <- scan("http://robjhyndman.com/tsdldata/data/nybirths.dat")
head(births)

#???? ?????? ?????? ?ð迭?ڷ??? ??ȯ
birthstimeseries <- ts(births, frequency=12, start=c(1946, 1))
head(birthstimeseries)
#???? ?ð迭 ?ڷḦ plot.ts ?Լ??? ????ȭ

plot.ts(birthstimeseries)

#--- ????���� ???? ?ð迭 ?ڷ???
#--- 1~3?????? ?????? ???? ?????ϰ? ???? ?ٽ? ???????ٰ?
#--- 9~12???? ?ٽ? ????
#--- ??????�� ???? ?ð迭?ڷ??? ???⼺, ??????, ?ұ?Ģ?? ???ҷ? ??????

# 4개의 그래프를 그려준다. 관찰/트렌드/계절별/랜덤(?)
birthstimeseriescomponents <- decompose(birthstimeseries)
plot(birthstimeseriescomponents)


birthstimeseriescomponents$x
birthstimeseriescomponents$trend
birthstimeseriescomponents$seasonal
birthstimeseriescomponents$random


# ?ð迭 ?ڷῡ?? ??��?? ???Ҹ? ��???ϱ?
birthstimeseries_seasonally_adjusted<-birthstimeseries -birthstimeseriescomponents$seasonal
plot(birthstimeseries_seasonally_adjusted)


#?????Ͽ? ��???? Ȯ???ϱ? (difference)

# diff ?Լ??? Ȱ???Ͽ? ?????? ?????ϱ?

# 1번 차분하여 정상화 그래프를 만든다.
births_adjusted <- birthstimeseries_seasonally_adjusted
births_adjusted_diff1 <- diff(births_adjusted, differences = 1)


#1?? ?????? ????, ???հ? ?л??? ?ð??? ??��???? ?ʴ? ??��?? ??��?ϰ? ????
plot.ts(births_adjusted_diff1)

mean(births_adjusted_diff1)
sd(births_adjusted_diff1)


# ARIMA ???? ??��?ϱ? ARIMA(p, 1, q)

# acf?Լ??? pacf ?Լ??? ?????Ͽ? ???? ??��?ϱ?

# 그래프가 바로 선택학 힘든 케이스라서, 바로 아리마 모형을 직접 사용한다.
# 판단하기 어렵기 때문에 , 오토 아리마를 사용한다.
par(mfrow=c(2,1))
acf(births_adjusted_diff1, lag.max=100)          #1?? ?????? ?????ͷ? (ACF) Ȯ??
pacf(births_adjusted_diff1, lag.max=100)         #1?? ?????? ?????ͷ? (PACF) Ȯ??



# forecast package ?? ?????? auto.arima ?Լ??? ?̿??? ???? ã??

auto.arima(births)
# 아리마의 판단은??--- ARIMA(1, 1, 0) �� ???? ?????? ????��?? ????


#  ARIMA ????�� ???? ?̷? ?????ϱ?
# ARIMA????��?? ?????? ??��?ϱ?(fitting)

birthstimeseriesARIMA<- arima(birthstimeseries, order=c(1, 1, 0))
birthstimeseriesARIMA

# forecast.Arima ?Լ??? ???? ?̷? ?????ϱ?
birthstimeseriesforecasts<-forecast(birthstimeseriesARIMA)
birthstimeseriesforecasts

# ?̷? ?????? ???? ??ǥ ?׸???
# 굉장히 뭉뚱그려지고, 안전한 데이터가 예측된다.
par(mfrow=c(2,1))
plot(birthstimeseriesforecasts)


# forecast ?Լ??? Ȱ???? ?ð迭 ???ϱ?
# 최근에는 좀더 계절별로 구체화된 예측기법이 나와있다.
forecast(birthstimeseries, h=12)
plot(forecast(birthstimeseries, h=12))


